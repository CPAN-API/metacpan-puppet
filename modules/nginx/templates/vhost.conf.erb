<% if @ssl && @ssl_only %>
server {
  listen 80;
  server_name <% @aliases.each do |val| %><%= val %> <% end %>;
  rewrite ^(.*)$ https://$host$1 permanent;
}

<% elsif @ssl %>
server {
  listen 80;
  server_name <% @aliases.each do |val| %><%= val %> <% end %>;
  <% if @html != '' %>
  root <%= @html %>;
  <% end %>
  access_log <%= @log_dir %>/access.log combined;
  error_log <%= @log_di %>/error.log info;

  gzip             on;
  gzip_proxied     any;
  gzip_vary        on;
  gzip_types       text/plain application/xml application/json application/javascript text/css image/svg+xml application/x-javascript;
  gzip_disable     "MSIE [1-6]\.";
  gzip_comp_level  4;

  <% unless @bare %>
  location / {
    index index.html index.htm;
    <% if @autoindex %>autoindex on;<% end %>
  }
  <% end %>

  include conf.d/<%= @name %>.d/*.conf;
}
<% end %>

server {
  listen <%= @ssl ? "443" : "80" %>;
  server_name <%= @domain %> <% @aliases.each do |val| %><%= val %> <% end %>;
  <% if @html != '' %>
  root <%= @html %>;
  <% end %>
  access_log <%= @log_dir %>/access.log combined;
  error_log <%= @log_dir %>/error.log info;

  gzip             on;
  gzip_proxied     any;
  gzip_vary        on;
  gzip_types       text/plain application/xml application/json application/javascript text/css image/svg+xml application/x-javascript;
  gzip_disable     "MSIE [1-6]\.";
  gzip_comp_level  4;

  <% if @ssl %>
  ssl on;
  ssl_certificate  <%= @root %>/ssl/server.crt;
  ssl_certificate_key <%= @root %>/ssl/server.key;
  ssl_session_timeout  5m;
  ssl_protocols  SSLv3 TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+EXP;
  ssl_prefer_server_ciphers on;
  <% end %>
  <% unless @bare %>
  location / {
    index index.html index.htm;
    <% if @autoindex %>autoindex on;<% end %>
  }
  <% end %>

  include conf.d/<%= @name %>.d/*.conf;

}
